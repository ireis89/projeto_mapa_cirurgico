<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitor Cirúrgico — Acompanhamento em Tempo Real</title>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;600;700&family=Sora:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #0a0e1a;
            --surface: #111827;
            --surface2: #1a2235;
            --border: #1e2d45;
            --accent: #00d4ff;
            --accent2: #7c3aed;
            --green: #10b981;
            --yellow: #f59e0b;
            --red: #ef4444;
            --gray: #6b7280;
            --text: #e2e8f0;
            --text-dim: #94a3b8;
            --mono: 'JetBrains Mono', monospace;
            --sans: 'Sora', sans-serif;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: var(--sans);
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Background grid effect */
        body::before {
            content: '';
            position: fixed;
            inset: 0;
            background-image: 
                linear-gradient(rgba(0, 212, 255, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 212, 255, 0.03) 1px, transparent 1px);
            background-size: 40px 40px;
            pointer-events: none;
            z-index: 0;
        }

        .container {
            position: relative;
            z-index: 1;
            max-width: 1400px;
            margin: 0 auto;
            padding: 24px;
        }

        /* ─── HEADER ─── */
        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 32px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border);
        }

        .header-left h1 {
            font-family: var(--mono);
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--accent);
            letter-spacing: 0.15em;
            text-transform: uppercase;
            margin-bottom: 4px;
        }

        .header-left p {
            font-size: 0.8rem;
            color: var(--text-dim);
            font-family: var(--mono);
            letter-spacing: 0.05em;
        }

        .live-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            padding: 6px 16px;
            border-radius: 20px;
        }

        .live-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--red);
            animation: livePulse 1.5s infinite;
        }

        @keyframes livePulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.4; transform: scale(0.8); }
        }

        .live-indicator span {
            font-family: var(--mono);
            font-size: 0.7rem;
            letter-spacing: 0.15em;
            color: var(--red);
            font-weight: 600;
        }

        .clock-display {
            font-family: var(--mono);
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--text);
            letter-spacing: 0.05em;
        }

        .date-display {
            font-family: var(--mono);
            font-size: 0.72rem;
            color: var(--text-dim);
            text-align: right;
            margin-top: 2px;
            letter-spacing: 0.05em;
        }

        /* ─── STATS BAR ─── */
        .stats-bar {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 12px;
            margin-bottom: 28px;
        }

        .stat-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 16px 20px;
            position: relative;
            overflow: hidden;
            transition: border-color 0.3s;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
        }

        .stat-card.total::before { background: var(--accent); }
        .stat-card.andamento::before { background: var(--red); }
        .stat-card.preparacao::before { background: var(--yellow); }
        .stat-card.agendado::before { background: var(--green); }
        .stat-card.concluido::before { background: var(--gray); }
        .stat-card.cancelado::before { background: #f87171; }
        .stat-card.reagendado::before { background: #a78bfa; }

        .stat-label {
            font-size: 0.65rem;
            letter-spacing: 0.12em;
            text-transform: uppercase;
            color: var(--text-dim);
            font-family: var(--mono);
            margin-bottom: 8px;
        }

        .stat-value {
            font-family: var(--mono);
            font-size: 2rem;
            font-weight: 700;
            line-height: 1;
        }

        .stat-card.total .stat-value { color: var(--accent); }
        .stat-card.andamento .stat-value { color: var(--red); }
        .stat-card.preparacao .stat-value { color: var(--yellow); }
        .stat-card.agendado .stat-value { color: var(--green); }
        .stat-card.concluido .stat-value { color: var(--gray); }
        .stat-card.cancelado .stat-value { color: #f87171; }
        .stat-card.reagendado .stat-value { color: #a78bfa; }

        /* ─── FILTERS ─── */
        .controls {
            display: flex;
            gap: 12px;
            margin-bottom: 24px;
            align-items: center;
            flex-wrap: wrap;
        }

        .filter-btn {
            font-family: var(--mono);
            font-size: 0.72rem;
            letter-spacing: 0.08em;
            padding: 8px 20px;
            border-radius: 6px;
            border: 1px solid var(--border);
            background: transparent;
            color: var(--text-dim);
            cursor: pointer;
            transition: all 0.2s;
            text-transform: uppercase;
        }

        .filter-btn.active, .filter-btn:hover {
            border-color: var(--accent);
            color: var(--accent);
            background: rgba(0, 212, 255, 0.05);
        }

        .search-box {
            flex: 1;
            max-width: 300px;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 8px 16px;
            color: var(--text);
            font-family: var(--mono);
            font-size: 0.78rem;
            letter-spacing: 0.05em;
            outline: none;
            transition: border-color 0.2s;
        }

        .search-box::placeholder { color: var(--text-dim); }
        .search-box:focus { border-color: var(--accent); }

        .btn-add {
            margin-left: auto;
            background: var(--accent);
            color: #000;
            border: none;
            padding: 9px 20px;
            border-radius: 6px;
            font-family: var(--mono);
            font-size: 0.72rem;
            letter-spacing: 0.1em;
            font-weight: 700;
            cursor: pointer;
            text-transform: uppercase;
            transition: all 0.2s;
        }

        .btn-add:hover {
            background: #00b8d9;
            transform: translateY(-1px);
        }

        /* ─── TIMELINE VIEW ─── */
        .view-tabs {
            display: flex;
            gap: 4px;
            margin-bottom: 20px;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 4px;
            width: fit-content;
        }

        .view-tab {
            font-family: var(--mono);
            font-size: 0.68rem;
            letter-spacing: 0.1em;
            padding: 7px 18px;
            border-radius: 5px;
            border: none;
            background: transparent;
            color: var(--text-dim);
            cursor: pointer;
            text-transform: uppercase;
            transition: all 0.2s;
        }

        .view-tab.active {
            background: var(--accent2);
            color: #fff;
        }

        /* ─── CARDS VIEW ─── */
        #cards-view {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(380px, 1fr));
            gap: 16px;
        }

        .proc-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            overflow: hidden;
            transition: transform 0.2s, border-color 0.2s, box-shadow 0.2s;
            animation: cardIn 0.3s ease both;
        }

        @keyframes cardIn {
            from { opacity: 0; transform: translateY(12px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .proc-card:hover {
            transform: translateY(-3px);
            border-color: rgba(0, 212, 255, 0.3);
            box-shadow: 0 8px 32px rgba(0, 212, 255, 0.05);
        }

        .proc-card.status-andamento { border-top: 2px solid var(--red); }
        .proc-card.status-preparacao { border-top: 2px solid var(--yellow); }
        .proc-card.status-agendado { border-top: 2px solid var(--green); }
        .proc-card.status-concluido { border-top: 2px solid var(--gray); opacity: 0.7; }
        .proc-card.status-cancelado { border-top: 2px solid #f87171; opacity: 0.5; }
        .proc-card.status-reagendado { border-top: 2px solid #a78bfa; }

        .card-header {
            padding: 16px 18px 12px;
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            gap: 12px;
            border-bottom: 1px solid var(--border);
        }

        .hospital-name {
            font-weight: 600;
            font-size: 0.9rem;
            color: var(--text);
            line-height: 1.3;
        }

        .status-pill {
            flex-shrink: 0;
            font-family: var(--mono);
            font-size: 0.62rem;
            letter-spacing: 0.1em;
            padding: 4px 10px;
            border-radius: 20px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .pill-andamento { background: rgba(239,68,68,0.15); color: var(--red); border: 1px solid rgba(239,68,68,0.4); }
        .pill-preparacao { background: rgba(245,158,11,0.15); color: var(--yellow); border: 1px solid rgba(245,158,11,0.4); }
        .pill-agendado { background: rgba(16,185,129,0.15); color: var(--green); border: 1px solid rgba(16,185,129,0.4); }
        .pill-concluido { background: rgba(107,114,128,0.15); color: var(--gray); border: 1px solid rgba(107,114,128,0.4); }
        .pill-cancelado { background: rgba(239,68,68,0.08); color: #f87171; border: 1px solid rgba(239,68,68,0.25); text-decoration: line-through; }
        .pill-reagendado { background: rgba(139,92,246,0.15); color: #a78bfa; border: 1px solid rgba(139,92,246,0.4); }

        .card-body {
            padding: 14px 18px;
        }

        .card-row {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            margin-bottom: 8px;
            font-size: 0.82rem;
        }

        .card-label {
            font-family: var(--mono);
            font-size: 0.65rem;
            letter-spacing: 0.1em;
            color: var(--text-dim);
            text-transform: uppercase;
        }

        .card-value {
            color: var(--text);
            text-align: right;
            max-width: 60%;
        }

        /* Timer */
        .timer-block {
            margin: 12px 0;
            background: var(--surface2);
            border-radius: 8px;
            padding: 12px 14px;
            border: 1px solid var(--border);
        }

        .timer-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .timer-label {
            font-family: var(--mono);
            font-size: 0.62rem;
            color: var(--text-dim);
            letter-spacing: 0.1em;
            text-transform: uppercase;
        }

        .timer-value {
            font-family: var(--mono);
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--accent);
            letter-spacing: 0.05em;
        }

        .timer-value.overdue { color: var(--red); animation: overduePulse 1s infinite; }

        @keyframes overduePulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .progress-bar-wrap {
            background: var(--border);
            border-radius: 4px;
            height: 4px;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            border-radius: 4px;
            transition: width 1s linear;
        }

        .progress-bar.ok { background: linear-gradient(90deg, var(--accent), var(--green)); }
        .progress-bar.warn { background: var(--yellow); }
        .progress-bar.over { background: var(--red); }

        /* Notes */
        .obs-block {
            background: rgba(124, 58, 237, 0.06);
            border-left: 2px solid var(--accent2);
            padding: 8px 12px;
            border-radius: 0 6px 6px 0;
            margin-top: 10px;
            font-size: 0.78rem;
            color: var(--text-dim);
            font-style: italic;
        }

        /* Card actions */
        .card-actions {
            display: flex;
            gap: 8px;
            padding: 12px 18px 14px;
            border-top: 1px solid var(--border);
        }

        .btn-act {
            flex: 1;
            padding: 7px;
            border: 1px solid var(--border);
            border-radius: 6px;
            background: transparent;
            color: var(--text-dim);
            font-family: var(--mono);
            font-size: 0.64rem;
            letter-spacing: 0.08em;
            cursor: pointer;
            text-transform: uppercase;
            transition: all 0.2s;
        }

        .btn-act:hover { color: var(--text); border-color: var(--text-dim); }
        .btn-act.conclude:hover { color: var(--green); border-color: var(--green); background: rgba(16,185,129,0.07); }
        .btn-act.edit:hover { color: var(--accent); border-color: var(--accent); background: rgba(0,212,255,0.07); }
        .btn-act.del:hover { color: var(--red); border-color: var(--red); background: rgba(239,68,68,0.07); }

        /* ─── TIMELINE VIEW ─── */
        #timeline-view { display: none; }

        .timeline-container {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 24px;
            overflow-x: auto;
        }

        .timeline-header {
            display: flex;
            margin-bottom: 20px;
            padding-left: 180px;
            position: relative;
        }

        .tl-hours {
            display: flex;
            flex: 1;
            min-width: 900px;
        }

        .tl-hour {
            flex: 1;
            font-family: var(--mono);
            font-size: 0.65rem;
            color: var(--text-dim);
            letter-spacing: 0.05em;
            border-left: 1px solid var(--border);
            padding-left: 4px;
        }

        .timeline-row {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
        }

        .tl-label {
            width: 180px;
            flex-shrink: 0;
            font-size: 0.75rem;
            color: var(--text);
            padding-right: 16px;
            line-height: 1.3;
        }

        .tl-label span {
            display: block;
            font-size: 0.62rem;
            color: var(--text-dim);
            font-family: var(--mono);
            margin-top: 2px;
        }

        .tl-track {
            flex: 1;
            position: relative;
            height: 36px;
            min-width: 900px;
        }

        .tl-track-bg {
            position: absolute;
            inset: 0;
            display: flex;
        }

        .tl-segment {
            flex: 1;
            border-left: 1px solid var(--border);
            height: 100%;
        }

        .tl-bar {
            position: absolute;
            top: 5px;
            height: 26px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            padding: 0 8px;
            font-family: var(--mono);
            font-size: 0.62rem;
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            z-index: 2;
            cursor: pointer;
            transition: filter 0.2s;
        }

        .tl-bar:hover { filter: brightness(1.2); }
        .tl-bar.andamento { background: rgba(239,68,68,0.3); border: 1px solid var(--red); color: var(--red); }
        .tl-bar.preparacao { background: rgba(245,158,11,0.3); border: 1px solid var(--yellow); color: var(--yellow); }
        .tl-bar.agendado { background: rgba(16,185,129,0.3); border: 1px solid var(--green); color: var(--green); }
        .tl-bar.concluido { background: rgba(107,114,128,0.2); border: 1px solid var(--gray); color: var(--gray); }
        .tl-bar.cancelado { background: rgba(248,113,113,0.1); border: 1px dashed #f87171; color: #f87171; opacity: 0.5; }
        .tl-bar.reagendado { background: rgba(167,139,250,0.2); border: 1px dashed #a78bfa; color: #a78bfa; }

        /* Now line */
        .tl-now-line {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 2px;
            background: var(--accent);
            z-index: 5;
            pointer-events: none;
        }

        .tl-now-line::before {
            content: 'agora';
            position: absolute;
            top: -18px;
            left: 50%;
            transform: translateX(-50%);
            font-family: var(--mono);
            font-size: 0.55rem;
            letter-spacing: 0.1em;
            color: var(--accent);
            background: var(--surface);
            padding: 1px 4px;
            border-radius: 3px;
            white-space: nowrap;
        }

        /* ─── MODAL ─── */
        .modal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.8);
            z-index: 100;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(4px);
        }

        .modal-overlay.open { display: flex; }

        .modal-box {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 16px;
            width: 90%;
            max-width: 560px;
            max-height: 90vh;
            overflow-y: auto;
            padding: 28px;
            animation: modalIn 0.25s ease;
        }

        @keyframes modalIn {
            from { opacity: 0; transform: scale(0.95) translateY(10px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }

        .modal-title {
            font-family: var(--mono);
            font-size: 0.78rem;
            letter-spacing: 0.15em;
            text-transform: uppercase;
            color: var(--accent);
            margin-bottom: 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-close {
            background: none;
            border: 1px solid var(--border);
            color: var(--text-dim);
            width: 28px;
            height: 28px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .modal-close:hover { color: var(--red); border-color: var(--red); }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 14px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .form-group.full { grid-column: 1 / -1; }

        .form-label {
            font-family: var(--mono);
            font-size: 0.62rem;
            letter-spacing: 0.12em;
            text-transform: uppercase;
            color: var(--text-dim);
        }

        .form-input, .form-select, .form-textarea {
            background: var(--surface2);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 10px 12px;
            color: var(--text);
            font-family: var(--sans);
            font-size: 0.82rem;
            outline: none;
            transition: border-color 0.2s;
        }

        .form-input:focus, .form-select:focus, .form-textarea:focus {
            border-color: var(--accent);
        }

        .form-textarea { resize: vertical; min-height: 70px; }

        .form-select option { background: var(--surface2); }

        .btn-save {
            width: 100%;
            margin-top: 20px;
            padding: 12px;
            background: var(--accent);
            color: #000;
            border: none;
            border-radius: 8px;
            font-family: var(--mono);
            font-size: 0.78rem;
            letter-spacing: 0.15em;
            text-transform: uppercase;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-save:hover { background: #00b8d9; }

        /* ─── ALERTS ─── */
        .alerts-panel {
            background: var(--surface);
            border: 1px solid rgba(239,68,68,0.3);
            border-radius: 12px;
            padding: 16px 20px;
            margin-bottom: 20px;
            display: none;
        }

        .alerts-panel.visible { display: block; }

        .alerts-title {
            font-family: var(--mono);
            font-size: 0.65rem;
            letter-spacing: 0.15em;
            text-transform: uppercase;
            color: var(--red);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .alert-item {
            font-size: 0.8rem;
            color: var(--yellow);
            padding: 4px 0;
            font-family: var(--mono);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* ─── EMPTY STATE ─── */
        .empty-state {
            text-align: center;
            padding: 60px;
            color: var(--text-dim);
            font-family: var(--mono);
            font-size: 0.8rem;
            letter-spacing: 0.08em;
        }

        /* ─── TABLE VIEW ─── */
        .table-wrap {
            overflow-x: auto;
            border-radius: 12px;
            border: 1px solid var(--border);
        }

        .proc-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.82rem;
            min-width: 1000px;
        }

        .proc-table thead tr {
            background: var(--surface2);
            border-bottom: 2px solid var(--border);
        }

        .proc-table th {
            font-family: var(--mono);
            font-size: 0.62rem;
            letter-spacing: 0.1em;
            text-transform: uppercase;
            color: var(--text-dim);
            padding: 12px 14px;
            text-align: left;
            white-space: nowrap;
            cursor: pointer;
            user-select: none;
            transition: color 0.2s;
        }

        .proc-table th:hover { color: var(--accent); }

        .proc-table th .sort-icon {
            display: inline-block;
            margin-left: 4px;
            opacity: 0.4;
            font-size: 0.7rem;
        }

        .proc-table th.sorted { color: var(--accent); }
        .proc-table th.sorted .sort-icon { opacity: 1; }

        .proc-table tbody tr {
            border-bottom: 1px solid var(--border);
            transition: background 0.15s;
            cursor: pointer;
        }

        .proc-table tbody tr:last-child { border-bottom: none; }
        .proc-table tbody tr:hover { background: rgba(255,255,255,0.03); }

        .proc-table tbody tr.row-andamento { border-left: 3px solid var(--red); }
        .proc-table tbody tr.row-preparacao { border-left: 3px solid var(--yellow); }
        .proc-table tbody tr.row-agendado { border-left: 3px solid var(--green); }
        .proc-table tbody tr.row-concluido { border-left: 3px solid var(--gray); opacity: 0.7; }
        .proc-table tbody tr.row-cancelado { border-left: 3px solid #f87171; opacity: 0.5; }
        .proc-table tbody tr.row-reagendado { border-left: 3px solid #a78bfa; }

        .proc-table td {
            padding: 10px 14px;
            color: var(--text);
            vertical-align: middle;
            max-width: 220px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .proc-table td.wrap-cell {
            white-space: normal;
            word-break: break-word;
        }

        .table-status-pill {
            display: inline-block;
            font-family: var(--mono);
            font-size: 0.6rem;
            letter-spacing: 0.08em;
            padding: 3px 8px;
            border-radius: 20px;
            font-weight: 600;
            text-transform: uppercase;
            white-space: nowrap;
        }

        .table-actions {
            display: flex;
            gap: 6px;
        }

        .table-btn {
            padding: 4px 10px;
            border: 1px solid var(--border);
            border-radius: 4px;
            background: transparent;
            color: var(--text-dim);
            font-family: var(--mono);
            font-size: 0.6rem;
            letter-spacing: 0.06em;
            cursor: pointer;
            text-transform: uppercase;
            transition: all 0.15s;
            white-space: nowrap;
        }

        .table-btn:hover { color: var(--text); border-color: var(--text-dim); }
        .table-btn.t-edit:hover { color: var(--accent); border-color: var(--accent); }
        .table-btn.t-conclude:hover { color: var(--green); border-color: var(--green); }
        .table-btn.t-del:hover { color: var(--red); border-color: var(--red); }

        .table-info-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 10px;
            font-family: var(--mono);
            font-size: 0.7rem;
            color: var(--text-dim);
        }

        .items-cell {
            font-size: 0.72rem;
            color: var(--text-dim);
            font-style: italic;
            max-width: 200px;
        }

        /* ─── ITEMS BLOCK ─── */
        .items-block {
            margin-top: 10px;
            background: rgba(0, 212, 255, 0.04);
            border: 1px solid rgba(0, 212, 255, 0.15);
            border-radius: 8px;
            padding: 10px 12px;
        }

        .items-block-title {
            font-family: var(--mono);
            font-size: 0.6rem;
            letter-spacing: 0.12em;
            text-transform: uppercase;
            color: var(--accent);
            margin-bottom: 6px;
        }

        .items-list {
            list-style: none;
            padding: 0;
        }

        .items-list li {
            font-size: 0.78rem;
            color: var(--text-dim);
            padding: 2px 0;
            display: flex;
            align-items: flex-start;
            gap: 6px;
        }

        .items-list li::before {
            content: '›';
            color: var(--accent);
            flex-shrink: 0;
        }

        /* ─── EXPORT BUTTON ─── */
        .btn-export {
            background: transparent;
            color: var(--green);
            border: 1px solid var(--green);
            padding: 9px 20px;
            border-radius: 6px;
            font-family: var(--mono);
            font-size: 0.72rem;
            letter-spacing: 0.1em;
            font-weight: 700;
            cursor: pointer;
            text-transform: uppercase;
            transition: all 0.2s;
        }

        .btn-export:hover {
            background: rgba(16, 185, 129, 0.1);
            transform: translateY(-1px);
        }

        /* ─── EXPORT MODAL ─── */
        .export-modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.85);
            z-index: 200;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(4px);
        }

        .export-modal.open { display: flex; }

        .export-box {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 16px;
            width: 90%;
            max-width: 460px;
            padding: 28px;
            animation: modalIn 0.25s ease;
        }

        .export-title {
            font-family: var(--mono);
            font-size: 0.78rem;
            letter-spacing: 0.15em;
            text-transform: uppercase;
            color: var(--green);
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .export-options {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 20px;
        }

        .export-opt {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            padding: 10px 14px;
            border-radius: 8px;
            border: 1px solid var(--border);
            transition: all 0.2s;
            color: var(--text);
            font-size: 0.83rem;
        }

        .export-opt:hover { border-color: var(--green); background: rgba(16,185,129,0.05); }
        .export-opt input[type="checkbox"] { accent-color: var(--green); width: 16px; height: 16px; cursor: pointer; }

        .export-date-range {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 20px;
        }

        .btn-do-export {
            width: 100%;
            padding: 12px;
            background: var(--green);
            color: #000;
            border: none;
            border-radius: 8px;
            font-family: var(--mono);
            font-size: 0.78rem;
            letter-spacing: 0.15em;
            text-transform: uppercase;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-do-export:hover { background: #059669; }

        /* ─── PERIOD FILTER BAR ─── */
        .period-bar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 12px 18px;
            margin-bottom: 14px;
            gap: 16px;
            flex-wrap: wrap;
        }

        .period-bar-left {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
        }

        .period-label {
            font-family: var(--mono);
            font-size: 0.65rem;
            letter-spacing: 0.12em;
            text-transform: uppercase;
            color: var(--text-dim);
            white-space: nowrap;
        }

        .period-presets {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }

        .preset-btn {
            font-family: var(--mono);
            font-size: 0.65rem;
            letter-spacing: 0.08em;
            padding: 5px 14px;
            border-radius: 20px;
            border: 1px solid var(--border);
            background: transparent;
            color: var(--text-dim);
            cursor: pointer;
            text-transform: uppercase;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .preset-btn:hover { border-color: var(--accent2); color: var(--accent2); }
        .preset-btn.active {
            background: var(--accent2);
            border-color: var(--accent2);
            color: #fff;
        }

        .period-custom {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .period-input {
            background: var(--surface2);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 6px 10px;
            color: var(--text);
            font-family: var(--mono);
            font-size: 0.72rem;
            outline: none;
            transition: border-color 0.2s;
        }

        .period-input:focus { border-color: var(--accent2); }

        .period-sep {
            color: var(--text-dim);
            font-family: var(--mono);
            font-size: 0.8rem;
        }

        .period-result {
            font-family: var(--mono);
            font-size: 0.68rem;
            color: var(--text-dim);
            white-space: nowrap;
            display: flex;
            gap: 14px;
            flex-wrap: wrap;
        }

        .period-stat {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .period-stat-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .period-stat-num {
            font-weight: 700;
            color: var(--text);
        }

        /* ─── ABC VIEW ─── */
        .abc-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 24px;
        }

        .abc-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px 24px;
        }

        .abc-card.full { grid-column: 1 / -1; }

        .abc-section-title {
            font-family: var(--mono);
            font-size: 0.65rem;
            letter-spacing: 0.15em;
            text-transform: uppercase;
            color: var(--text-dim);
            margin-bottom: 18px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .abc-section-title span { color: var(--accent); font-size: 0.9rem; }

        /* Ranking rows */
        .abc-row {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 0;
            border-bottom: 1px solid var(--border);
        }

        .abc-row:last-child { border-bottom: none; }

        .abc-rank {
            font-family: var(--mono);
            font-size: 0.75rem;
            font-weight: 700;
            width: 24px;
            text-align: center;
            flex-shrink: 0;
        }

        .abc-badge {
            font-family: var(--mono);
            font-size: 0.62rem;
            font-weight: 700;
            letter-spacing: 0.1em;
            padding: 3px 9px;
            border-radius: 4px;
            flex-shrink: 0;
            width: 28px;
            text-align: center;
        }

        .badge-A { background: rgba(16,185,129,0.2); color: #10b981; border: 1px solid rgba(16,185,129,0.4); }
        .badge-B { background: rgba(245,158,11,0.2); color: #f59e0b; border: 1px solid rgba(245,158,11,0.4); }
        .badge-C { background: rgba(107,114,128,0.2); color: #9ca3af; border: 1px solid rgba(107,114,128,0.4); }

        .abc-name {
            flex: 1;
            font-size: 0.83rem;
            font-weight: 600;
            color: var(--text);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .abc-bar-wrap {
            flex: 2;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .abc-bar-track {
            flex: 1;
            background: var(--border);
            border-radius: 4px;
            height: 8px;
            overflow: hidden;
        }

        .abc-bar-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.6s ease;
        }

        .fill-A { background: linear-gradient(90deg, #10b981, #34d399); }
        .fill-B { background: linear-gradient(90deg, #f59e0b, #fbbf24); }
        .fill-C { background: #6b7280; }

        .abc-count {
            font-family: var(--mono);
            font-size: 0.78rem;
            font-weight: 700;
            color: var(--text);
            flex-shrink: 0;
            min-width: 24px;
            text-align: right;
        }

        .abc-pct {
            font-family: var(--mono);
            font-size: 0.65rem;
            color: var(--text-dim);
            flex-shrink: 0;
            min-width: 44px;
            text-align: right;
        }

        .abc-acum {
            font-family: var(--mono);
            font-size: 0.62rem;
            color: var(--text-dim);
            flex-shrink: 0;
            min-width: 50px;
            text-align: right;
        }

        /* Status breakdown per vendor */
        .abc-status-pills {
            display: flex;
            gap: 4px;
            flex-wrap: wrap;
            margin-top: 4px;
        }

        .abc-mini-pill {
            font-family: var(--mono);
            font-size: 0.55rem;
            letter-spacing: 0.06em;
            padding: 2px 6px;
            border-radius: 3px;
        }

        /* Summary boxes */
        .abc-summary {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }

        .abc-sum-box {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 14px 16px;
            text-align: center;
        }

        .abc-sum-label {
            font-family: var(--mono);
            font-size: 0.6rem;
            letter-spacing: 0.12em;
            text-transform: uppercase;
            margin-bottom: 6px;
        }

        .abc-sum-val {
            font-family: var(--mono);
            font-size: 1.6rem;
            font-weight: 700;
        }

        .abc-sum-sub {
            font-family: var(--mono);
            font-size: 0.62rem;
            color: var(--text-dim);
            margin-top: 2px;
        }

        .abc-sum-box.zona-A .abc-sum-label { color: #10b981; }
        .abc-sum-box.zona-A .abc-sum-val { color: #10b981; }
        .abc-sum-box.zona-B .abc-sum-label { color: #f59e0b; }
        .abc-sum-box.zona-B .abc-sum-val { color: #f59e0b; }
        .abc-sum-box.zona-C .abc-sum-label { color: #9ca3af; }
        .abc-sum-box.zona-C .abc-sum-val { color: #9ca3af; }

        /* Status distribution chart */
        .abc-stacked {
            display: flex;
            height: 28px;
            border-radius: 6px;
            overflow: hidden;
            margin-bottom: 10px;
            gap: 2px;
        }

        .abc-stacked-seg {
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: var(--mono);
            font-size: 0.6rem;
            font-weight: 700;
            transition: width 0.6s ease;
            overflow: hidden;
            white-space: nowrap;
        }

        /* Vendor detail table */
        .abc-detail-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.8rem;
        }

        .abc-detail-table th {
            font-family: var(--mono);
            font-size: 0.6rem;
            letter-spacing: 0.1em;
            text-transform: uppercase;
            color: var(--text-dim);
            padding: 8px 12px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        .abc-detail-table td {
            padding: 8px 12px;
            color: var(--text);
            border-bottom: 1px solid rgba(30,45,69,0.5);
            vertical-align: middle;
        }

        .abc-detail-table tr:last-child td { border-bottom: none; }
        .abc-detail-table tr:hover td { background: rgba(255,255,255,0.02); }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: var(--surface); }
        ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--text-dim); }

        @media (max-width: 768px) {
            .stats-bar { grid-template-columns: repeat(3, 1fr); }
            #cards-view { grid-template-columns: 1fr; }
            .form-grid { grid-template-columns: 1fr; }
            .clock-display { font-size: 1.2rem; }
        }
    </style>
</head>
<body>
<div class="container">

    <!-- HEADER -->
    <div class="header">
        <div class="header-left">
            <div style="display:flex;align-items:center;gap:16px;margin-bottom:6px;">
                <img src="data:image/jpeg;base64,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" 
                     alt="GF Medical" style="height:52px;object-fit:contain;border-radius:6px;">
                <div>
                    <h1>⬡ Monitor Cirúrgico</h1>
                    <p>Acompanhamento em tempo real · Campo Grande, MS</p>
                </div>
            </div>
        </div>
        <div style="display:flex; align-items:center; gap:20px;">
            <div class="live-indicator">
                <div class="live-dot"></div>
                <span>Ao vivo</span>
            </div>
            <div>
                <div class="clock-display" id="clock">--:--:--</div>
                <div class="date-display" id="dateDisplay">--</div>
            </div>
        </div>
    </div>

    <!-- STATS BAR -->
    <div class="stats-bar">
        <div class="stat-card total">
            <div class="stat-label">Total hoje</div>
            <div class="stat-value" id="stat-total">0</div>
        </div>
        <div class="stat-card andamento">
            <div class="stat-label">Em andamento</div>
            <div class="stat-value" id="stat-andamento">0</div>
        </div>
        <div class="stat-card preparacao">
            <div class="stat-label">Preparação</div>
            <div class="stat-value" id="stat-preparacao">0</div>
        </div>
        <div class="stat-card agendado">
            <div class="stat-label">Agendados</div>
            <div class="stat-value" id="stat-agendado">0</div>
        </div>
        <div class="stat-card concluido">
            <div class="stat-label">Concluídos</div>
            <div class="stat-value" id="stat-concluido">0</div>
        </div>
        <div class="stat-card cancelado">
            <div class="stat-label">Cancelados</div>
            <div class="stat-value" id="stat-cancelado">0</div>
        </div>
        <div class="stat-card reagendado">
            <div class="stat-label">Reagendados</div>
            <div class="stat-value" id="stat-reagendado">0</div>
        </div>
    </div>

    <!-- ALERTS -->
    <div class="alerts-panel" id="alertsPanel">
        <div class="alerts-title">
            <span>⚠</span> Alertas de Atraso
        </div>
        <div id="alertsList"></div>
    </div>

    <!-- PERIOD FILTER -->
    <div class="period-bar" id="periodBar">
        <div class="period-bar-left">
            <span class="period-label">📅 Período</span>
            <div class="period-presets">
                <button class="preset-btn active" data-preset="hoje" onclick="applyPreset('hoje')">Hoje</button>
                <button class="preset-btn" data-preset="semana" onclick="applyPreset('semana')">Esta semana</button>
                <button class="preset-btn" data-preset="mes" onclick="applyPreset('mes')">Este mês</button>
                <button class="preset-btn" data-preset="todos" onclick="applyPreset('todos')">Todos</button>
                <button class="preset-btn" data-preset="custom" onclick="applyPreset('custom')">Personalizado</button>
            </div>
            <div class="period-custom" id="periodCustom" style="display:none;">
                <input class="period-input" type="date" id="filterDe" onchange="applyCustomPeriod()">
                <span class="period-sep">→</span>
                <input class="period-input" type="date" id="filterAte" onchange="applyCustomPeriod()">
            </div>
        </div>
        <div class="period-result" id="periodResult"></div>
    </div>

    <!-- CONTROLS -->
    <div class="controls">
        <button class="filter-btn active" data-filter="all">Todos</button>
        <button class="filter-btn" data-filter="andamento">Em Andamento</button>
        <button class="filter-btn" data-filter="preparacao">Preparação</button>
        <button class="filter-btn" data-filter="agendado">Agendados</button>
        <button class="filter-btn" data-filter="concluido">Concluídos</button>
        <button class="filter-btn" data-filter="cancelado">Cancelados</button>
        <button class="filter-btn" data-filter="reagendado">Reagendados</button>
        <input class="search-box" type="text" id="searchBox" placeholder="Buscar hospital, médico, procedimento...">
        <button class="btn-export" onclick="openExportModal()">⬇ Exportar Excel</button>
        <button class="btn-add" onclick="openModal()">+ Adicionar</button>
    </div>

    <!-- VIEW TABS -->
    <div class="view-tabs">
        <button class="view-tab active" id="tab-cards" onclick="switchView('cards')">⊞ Cards</button>
        <button class="view-tab" id="tab-timeline" onclick="switchView('timeline')">⟶ Linha do Tempo</button>
        <button class="view-tab" id="tab-table" onclick="switchView('table')">⊟ Tabela</button>
        <button class="view-tab" id="tab-abc" onclick="switchView('abc')">◈ Curva ABC</button>
    </div>

    <!-- CARDS VIEW -->
    <div id="cards-view"></div>

    <!-- TIMELINE VIEW -->
    <div id="timeline-view">
        <div class="timeline-container" id="timelineContainer"></div>
    </div>

    <!-- TABLE VIEW -->
    <div id="table-view" style="display:none;">
        <div class="table-wrap">
            <table class="proc-table" id="procTable">
                <thead></thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <!-- ABC VIEW -->
    <div id="abc-view" style="display:none;">
        <div id="abcContent"></div>
    </div>

</div>

<!-- MODAL -->
<div class="modal-overlay" id="modalOverlay">
    <div class="modal-box">
        <div class="modal-title">
            <span id="modalTitle">Adicionar Procedimento</span>
            <button class="modal-close" onclick="closeModal()">✕</button>
        </div>
        <form id="procForm" onsubmit="saveProcedure(event)">
            <input type="hidden" id="editIndex">
            <div class="form-grid">
                <div class="form-group full">
                    <label class="form-label">Hospital *</label>
                    <select class="form-select" id="f-hospital" required>
                        <option value="">Selecione</option>
                        <option>Hospital Santa Casa Campo Grande</option>
                        <option>Hospital Unimed de Campo Grande</option>
                        <option>Hospital Proncor</option>
                        <option>Hospital Penfigo</option>
                        <option>Hospital Geral El Kadri</option>
                        <option value="__outro">Outro...</option>
                    </select>
                </div>
                <div class="form-group full" id="g-outro-hosp" style="display:none;">
                    <label class="form-label">Nome do Hospital</label>
                    <input class="form-input" id="f-outro-hospital" placeholder="Digite o nome">
                </div>

                <div class="form-group">
                    <label class="form-label">Status *</label>
                    <select class="form-select" id="f-status" required>
                        <option value="agendado">Agendado</option>
                        <option value="preparacao">Em Preparação</option>
                        <option value="andamento">Em Andamento</option>
                        <option value="concluido">Concluído</option>
                        <option value="cancelado">Cancelado</option>
                        <option value="reagendado">Reagendado</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">Data *</label>
                    <input class="form-input" type="date" id="f-data" required>
                </div>

                <div class="form-group full">
                    <label class="form-label">Médico *</label>
                    <input class="form-input" id="f-medico" required placeholder="Dr(a). Nome">
                </div>

                <div class="form-group full">
                    <label class="form-label">Procedimento</label>
                    <textarea class="form-textarea" id="f-procedimento" placeholder="Descreva o procedimento"></textarea>
                </div>

                <div class="form-group">
                    <label class="form-label">Convênio *</label>
                    <select class="form-select" id="f-convenio" required>
                        <option value="">Selecione</option>
                        <option>SUS</option>
                        <option>Unimed</option>
                        <option>Bradesco Saúde</option>
                        <option>Amil</option>
                        <option>SulAmérica</option>
                        <option>Cassems</option>
                        <option>Particular</option>
                        <option value="__outro">Outro...</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">Vendedor *</label>
                    <select class="form-select" id="f-vendedor" required>
                        <option value="">Selecione</option>
                        <option>Tiago da Silva Siqueira</option>
                        <option>Marcos Gonçalves da Silva</option>
                        <option>Marcella Fernandes Ricci</option>
                        <option>Wilson Cordeiro e Silva Junior</option>
                        <option>Lucas Matheus</option>
                        <option>Roberto Alex Cândido</option>
                    </select>
                </div>

                <div class="form-group" id="g-outro-conv" style="display:none;">
                    <label class="form-label">Nome do Convênio</label>
                    <input class="form-input" id="f-outro-convenio" placeholder="Digite o convênio">
                </div>

                <div class="form-group">
                    <label class="form-label">Linha de Produtos</label>
                    <input class="form-input" id="f-linha" placeholder="Ex: Cardiologia">
                </div>

                <div class="form-group">
                    <label class="form-label">Horário de Início</label>
                    <input class="form-input" type="time" id="f-inicio">
                </div>

                <div class="form-group full">
                    <label class="form-label">Equipe</label>
                    <input class="form-input" id="f-equipe" placeholder="Ex: Equipe Cardio A">
                </div>

                <div class="form-group full">
                    <label class="form-label">📋 Itens da Autorização / Solicitação</label>
                    <textarea class="form-textarea" id="f-itens" placeholder="Ex: Stent coronário × 2&#10;Fio de sutura 3-0 × 5&#10;Placa de titânio..." style="min-height:110px;"></textarea>
                </div>

                <div class="form-group full">
                    <label class="form-label">Observações</label>
                    <textarea class="form-textarea" id="f-obs" placeholder="Notas adicionais"></textarea>
                </div>
            </div>
            <button type="submit" class="btn-save">Salvar Procedimento</button>
        </form>
    </div>
</div>

<!-- EXPORT MODAL -->
<div class="export-modal" id="exportModal">
    <div class="export-box">
        <div class="export-title">
            <span>📊 Exportar para Excel</span>
            <button class="modal-close" onclick="closeExportModal()">✕</button>
        </div>

        <div style="margin-bottom:16px;">
            <div class="form-label" style="margin-bottom:8px;">Filtrar por período</div>
            <div class="export-date-range">
                <div class="form-group">
                    <label class="form-label">De</label>
                    <input class="form-input" type="date" id="exp-de">
                </div>
                <div class="form-group">
                    <label class="form-label">Até</label>
                    <input class="form-input" type="date" id="exp-ate">
                </div>
            </div>
        </div>

        <div style="margin-bottom:16px;">
            <div class="form-label" style="margin-bottom:10px;">Filtrar por vendedor</div>
            <div class="export-options" id="exportVendedores">
                <label class="export-opt">
                    <input type="checkbox" value="__todos" id="exp-todos" checked onchange="toggleTodosVendedores(this)">
                    Todos os vendedores
                </label>
                <label class="export-opt">
                    <input type="checkbox" class="exp-vendedor" value="Tiago da Silva Siqueira" checked>
                    Tiago da Silva Siqueira
                </label>
                <label class="export-opt">
                    <input type="checkbox" class="exp-vendedor" value="Marcos Gonçalves da Silva" checked>
                    Marcos Gonçalves da Silva
                </label>
                <label class="export-opt">
                    <input type="checkbox" class="exp-vendedor" value="Marcella Fernandes Ricci" checked>
                    Marcella Fernandes Ricci
                </label>
                <label class="export-opt">
                    <input type="checkbox" class="exp-vendedor" value="Wilson Cordeiro e Silva Junior" checked>
                    Wilson Cordeiro e Silva Junior
                </label>
                <label class="export-opt">
                    <input type="checkbox" class="exp-vendedor" value="Lucas Matheus" checked>
                    Lucas Matheus
                </label>
                <label class="export-opt">
                    <input type="checkbox" class="exp-vendedor" value="Roberto Alex Cândido" checked>
                    Roberto Alex Cândido
                </label>
            </div>
        </div>

        <div style="margin-bottom:20px;">
            <div class="form-label" style="margin-bottom:10px;">Filtrar por status</div>
            <div class="export-options">
                <label class="export-opt">
                    <input type="checkbox" class="exp-status" value="agendado" checked> Agendado
                </label>
                <label class="export-opt">
                    <input type="checkbox" class="exp-status" value="preparacao" checked> Em Preparação
                </label>
                <label class="export-opt">
                    <input type="checkbox" class="exp-status" value="andamento" checked> Em Andamento
                </label>
                <label class="export-opt">
                    <input type="checkbox" class="exp-status" value="concluido" checked> Concluído
                </label>
                <label class="export-opt">
                    <input type="checkbox" class="exp-status" value="cancelado" checked> Cancelado
                </label>
                <label class="export-opt">
                    <input type="checkbox" class="exp-status" value="reagendado" checked> Reagendado
                </label>
            </div>
        </div>

        <button class="btn-do-export" onclick="doExport()">⬇ Baixar Planilha Excel</button>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script>
// ─── DATA STORE ───
let procedimentos = JSON.parse(localStorage.getItem('proc_data') || 'null') || [
    { id:1, hospital:'Hospital Santa Casa Campo Grande', status:'andamento', medico:'Dr. Carlos Eduardo Mendes', convenio:'Unimed', procedimento:'Revascularização Miocárdica', vendedor:'Tiago da Silva Siqueira', linha:'Cirurgia Cardíaca', equipe:'Equipe Cardio A', data: todayStr(), inicio:'08:00', fim:'12:00', obs:'Procedimento complexo, requer instrumentação completa' },
    { id:2, hospital:'Hospital Unimed de Campo Grande', status:'preparacao', medico:'Dra. Ana Paula Fernandes', convenio:'SUS', procedimento:'Angioplastia Coronária', vendedor:'Marcos Gonçalves da Silva', linha:'Cardiologia Intervencionista', equipe:'Equipe Hemodinâmica', data: todayStr(), inicio:'10:00', fim:'13:00', obs:'Verificar disponibilidade de stents coronários' },
    { id:3, hospital:'Hospital Proncor', status:'andamento', medico:'Dr. Roberto Santos Lima', convenio:'Particular', procedimento:'Biópsia Renal Percutânea', vendedor:'Marcella Fernandes Ricci', linha:'Nefrologia', equipe:'Equipe Nefro', data: todayStr(), inicio:'09:30', fim:'11:30', obs:'Utilizar equipamento de ultrassom portátil' }
];

let nextId = Math.max(...procedimentos.map(p=>p.id), 0) + 1;
let currentFilter = 'all';
let currentView = 'cards';
let searchTerm = '';
let editingIndex = null;
let periodoDe = todayStr();
let periodoAte = todayStr();
let currentPreset = 'hoje';

function todayStr() {
    return new Date().toISOString().split('T')[0];
}

function save() {
    localStorage.setItem('proc_data', JSON.stringify(procedimentos));
}

// ─── CLOCK ───
function updateClock() {
    const now = new Date();
    document.getElementById('clock').textContent = now.toLocaleTimeString('pt-BR');
    document.getElementById('dateDisplay').textContent = now.toLocaleDateString('pt-BR', { weekday:'long', day:'2-digit', month:'long', year:'numeric' });
    updateTimers();
    updateAlerts();
    if (currentView === 'timeline') renderTimeline();
}

setInterval(updateClock, 1000);
updateClock();

// ─── HELPERS ───
function timeToMinutes(t) {
    if (!t) return null;
    const [h, m] = t.split(':').map(Number);
    return h * 60 + m;
}

function minutesToStr(mins) {
    if (mins < 0) mins = -mins;
    const h = Math.floor(mins / 60);
    const m = mins % 60;
    return h > 0 ? `${h}h ${String(m).padStart(2,'0')}min` : `${m}min`;
}

function getElapsed(proc) {
    return null; // fim field removed
}

// ─── STATS ───
function updateStats() {
    const today = todayStr();
    const todayProcs = procedimentos.filter(p => p.data === today);
    document.getElementById('stat-total').textContent = todayProcs.length;
    ['andamento','preparacao','agendado','concluido','cancelado','reagendado'].forEach(s => {
        document.getElementById('stat-' + s).textContent = todayProcs.filter(p => p.status === s).length;
    });
}

// ─── ALERTS ───
function updateAlerts() {
    // Alerts based on overdue are removed since fim field no longer exists
    document.getElementById('alertsPanel').classList.remove('visible');
}

// ─── RENDER CARDS ───
function getFiltered() {
    return procedimentos.filter(p => {
        const matchFilter = currentFilter === 'all' || p.status === currentFilter;
        const q = searchTerm.toLowerCase();
        const matchSearch = !q || [p.hospital, p.medico, p.procedimento, p.vendedor, p.linha, p.equipe, p.convenio].some(v => v && v.toLowerCase().includes(q));
        const matchPeriod = currentPreset === 'todos' || (
            (!periodoDe || p.data >= periodoDe) &&
            (!periodoAte || p.data <= periodoAte)
        );
        return matchFilter && matchSearch && matchPeriod;
    });
}

function statusLabel(s) {
    return { andamento:'Em Andamento', preparacao:'Em Preparação', agendado:'Agendado', concluido:'Concluído', cancelado:'Cancelado', reagendado:'Reagendado' }[s] || s;
}

function renderCards() {
    updateStats();
    updatePeriodResult();
    if (currentView === 'table') { renderTable(); return; }
    if (currentView === 'abc') { renderABC(); return; }
    const grid = document.getElementById('cards-view');
    const list = getFiltered();

    if (list.length === 0) {
        grid.innerHTML = '<div class="empty-state">Nenhum procedimento encontrado</div>';
        return;
    }

    grid.innerHTML = list.map((proc, fi) => {
        const realIndex = procedimentos.indexOf(proc);
        const dataFmt = new Date(proc.data + 'T00:00:00').toLocaleDateString('pt-BR');
        const isToday = proc.data === todayStr();
        const active = (proc.status === 'andamento' || proc.status === 'preparacao') && isToday;
        const elapsed = active ? getElapsed(proc) : null;

        let timerHTML = '';
        if (elapsed && proc.status === 'andamento') {
            const cls = elapsed.overdue ? 'over' : (elapsed.progress > 80 ? 'warn' : 'ok');
            const overdueCls = elapsed.overdue ? 'overdue' : '';
            const timeStr = elapsed.overdue
                ? `+${minutesToStr(-elapsed.remaining)}`
                : minutesToStr(elapsed.elapsed);
            timerHTML = `
                <div class="timer-block">
                    <div class="timer-header">
                        <span class="timer-label">${elapsed.overdue ? '⚠ Atraso' : '⏱ Decorrido'}</span>
                        <span class="timer-value ${overdueCls}" id="timer-${proc.id}">${timeStr}</span>
                    </div>
                    <div class="progress-bar-wrap">
                        <div class="progress-bar ${cls}" id="prog-${proc.id}" style="width:${elapsed.progress}%"></div>
                    </div>
                </div>`;
        }

        const obsHTML = proc.obs ? `<div class="obs-block">${proc.obs}</div>` : '';

        let itensHTML = '';
        if (proc.itens && proc.itens.trim()) {
            const linhas = proc.itens.split('\n').map(l => l.trim()).filter(l => l);
            itensHTML = `
                <div class="items-block">
                    <div class="items-block-title">📋 Itens da Autorização / Solicitação</div>
                    <ul class="items-list">
                        ${linhas.map(l => `<li>${l}</li>`).join('')}
                    </ul>
                </div>`;
        }

        const concludeBtn = proc.status !== 'concluido'
            ? `<button class="btn-act conclude" onclick="conclude(${realIndex})">✓ Concluir</button>` : '';

        return `
        <div class="proc-card status-${proc.status}" data-id="${proc.id}">
            <div class="card-header">
                <div class="hospital-name">🏥 ${proc.hospital}</div>
                <div class="status-pill pill-${proc.status}">${statusLabel(proc.status)}</div>
            </div>
            <div class="card-body">
                <div class="card-row">
                    <span class="card-label">Médico</span>
                    <span class="card-value">${proc.medico}</span>
                </div>
                <div class="card-row">
                    <span class="card-label">Procedimento</span>
                    <span class="card-value">${proc.procedimento}</span>
                </div>
                <div class="card-row">
                    <span class="card-label">Convênio</span>
                    <span class="card-value">${proc.convenio}</span>
                </div>
                <div class="card-row">
                    <span class="card-label">Vendedor</span>
                    <span class="card-value">${proc.vendedor}</span>
                </div>
                <div class="card-row">
                    <span class="card-label">Linha</span>
                    <span class="card-value">${proc.linha || '—'}</span>
                </div>
                <div class="card-row">
                    <span class="card-label">Data</span>
                    <span class="card-value">${dataFmt}</span>
                </div>
                <div class="card-row">
                    <span class="card-label">Horário</span>
                    <span class="card-value">${proc.inicio || '—'}</span>
                </div>
                ${proc.equipe ? `<div class="card-row"><span class="card-label">Equipe</span><span class="card-value">${proc.equipe}</span></div>` : ''}
                ${timerHTML}
                ${itensHTML}
                ${obsHTML}
            </div>
            <div class="card-actions">
                <button class="btn-act edit" onclick="editProc(${realIndex})">✏ Editar</button>
                ${concludeBtn}
                <button class="btn-act del" onclick="deleteProc(${realIndex})">✕ Excluir</button>
            </div>
        </div>`;
    }).join('');
}

// Update timers without full re-render
function updateTimers() {
    const now = new Date();
    const nowMin = now.getHours() * 60 + now.getMinutes();
    procedimentos.forEach(proc => {
        if (proc.status !== 'andamento' || proc.data !== todayStr()) return;
        const el = document.getElementById('timer-' + proc.id);
        const prog = document.getElementById('prog-' + proc.id);
        if (!el) return;
        const e = getElapsed(proc);
        if (!e) return;
        const timeStr = e.overdue ? `+${minutesToStr(-e.remaining)}` : minutesToStr(e.elapsed);
        el.textContent = timeStr;
        if (e.overdue) el.classList.add('overdue'); else el.classList.remove('overdue');
        if (prog) {
            prog.style.width = e.progress + '%';
            prog.className = 'progress-bar ' + (e.overdue ? 'over' : (e.progress > 80 ? 'warn' : 'ok'));
        }
    });
}

// ─── TIMELINE ───
function renderTimeline() {
    const container = document.getElementById('timelineContainer');
    const today = todayStr();
    const list = procedimentos.filter(p => p.data === today);

    // Determine time range (7h to 20h default)
    let minH = 7, maxH = 20;
    list.forEach(p => {
        if (p.inicio) minH = Math.min(minH, Math.floor(timeToMinutes(p.inicio) / 60) - 1);
    });
    minH = Math.max(0, minH);
    maxH = Math.min(24, maxH);
    const totalMins = (maxH - minH) * 60;

    // Now position
    const now = new Date();
    const nowMin = now.getHours() * 60 + now.getMinutes();
    const nowPct = Math.max(0, Math.min(100, (nowMin - minH * 60) / totalMins * 100));

    // Hours header
    const hours = [];
    for (let h = minH; h <= maxH; h++) {
        hours.push(`<div class="tl-hour">${String(h).padStart(2,'0')}:00</div>`);
    }

    // Rows
    const rows = list.length === 0
        ? '<div class="empty-state">Nenhum procedimento para hoje</div>'
        : list.map((proc) => {
            const start = timeToMinutes(proc.inicio);
            if (start === null) return '';
            const leftPct = (start - minH * 60) / totalMins * 100;
            return `
            <div class="timeline-row">
                <div class="tl-label">
                    ${proc.hospital.replace('Hospital ', '')}
                    <span>${proc.medico}</span>
                </div>
                <div class="tl-track">
                    <div class="tl-track-bg">${hours.map(() => '<div class="tl-segment"></div>').join('')}</div>
                    <div class="tl-now-line" style="left:${nowPct}%"></div>
                    <div class="tl-bar ${proc.status}" style="left:${Math.max(0,leftPct - 0.5)}%;width:auto;min-width:fit-content;" title="${proc.procedimento}">
                        ${proc.inicio} · ${proc.procedimento || proc.hospital}
                    </div>
                </div>
            </div>`;
        }).join('');

    container.innerHTML = `
        <div class="timeline-header">
            <div class="tl-hours">${hours.join('')}</div>
        </div>
        ${rows}
    `;
}

// ─── ACTIONS ───
function conclude(index) {
    if (confirm('Marcar como concluído?')) {
        procedimentos[index].status = 'concluido';
        save();
        renderCards();
        updateStats();
    }
}

function deleteProc(index) {
    if (confirm('Excluir este procedimento?')) {
        procedimentos.splice(index, 1);
        save();
        renderCards();
        updateStats();
    }
}

function editProc(index) {
    const p = procedimentos[index];
    editingIndex = index;
    document.getElementById('modalTitle').textContent = 'Editar Procedimento';
    document.getElementById('editIndex').value = index;

    // Hospital
    const hs = document.getElementById('f-hospital');
    const hOpts = Array.from(hs.options).map(o => o.value);
    if (hOpts.includes(p.hospital)) {
        hs.value = p.hospital;
        document.getElementById('g-outro-hosp').style.display = 'none';
    } else {
        hs.value = '__outro';
        document.getElementById('g-outro-hosp').style.display = 'block';
        document.getElementById('f-outro-hospital').value = p.hospital;
    }

    // Convenio
    const cs = document.getElementById('f-convenio');
    const cOpts = Array.from(cs.options).map(o => o.value);
    if (cOpts.includes(p.convenio)) {
        cs.value = p.convenio;
        document.getElementById('g-outro-conv').style.display = 'none';
    } else {
        cs.value = '__outro';
        document.getElementById('g-outro-conv').style.display = 'block';
        document.getElementById('f-outro-convenio').value = p.convenio;
    }

    document.getElementById('f-status').value = p.status;
    document.getElementById('f-data').value = p.data;
    document.getElementById('f-medico').value = p.medico;
    document.getElementById('f-procedimento').value = p.procedimento;
    document.getElementById('f-vendedor').value = p.vendedor;
    document.getElementById('f-linha').value = p.linha || '';
    document.getElementById('f-inicio').value = p.inicio;
    document.getElementById('f-equipe').value = p.equipe || '';
    document.getElementById('f-itens').value = p.itens || '';
    document.getElementById('f-obs').value = p.obs || '';

    document.getElementById('modalOverlay').classList.add('open');
}

// ─── MODAL ───
function openModal() {
    editingIndex = null;
    document.getElementById('modalTitle').textContent = 'Adicionar Procedimento';
    document.getElementById('procForm').reset();
    document.getElementById('editIndex').value = '';
    document.getElementById('f-data').value = todayStr();
    document.getElementById('g-outro-hosp').style.display = 'none';
    document.getElementById('g-outro-conv').style.display = 'none';
    document.getElementById('modalOverlay').classList.add('open');
}

function closeModal() {
    document.getElementById('modalOverlay').classList.remove('open');
}

function saveProcedure(e) {
    e.preventDefault();

    let hospital = document.getElementById('f-hospital').value;
    if (hospital === '__outro') {
        hospital = document.getElementById('f-outro-hospital').value.trim();
        if (!hospital) { alert('Informe o nome do hospital'); return; }
    }

    let convenio = document.getElementById('f-convenio').value;
    if (convenio === '__outro') {
        convenio = document.getElementById('f-outro-convenio').value.trim();
        if (!convenio) { alert('Informe o nome do convênio'); return; }
    }

    const proc = {
        id: editingIndex !== null ? procedimentos[editingIndex].id : nextId++,
        hospital,
        status: document.getElementById('f-status').value,
        data: document.getElementById('f-data').value,
        medico: document.getElementById('f-medico').value,
        procedimento: document.getElementById('f-procedimento').value,
        convenio,
        vendedor: document.getElementById('f-vendedor').value,
        linha: document.getElementById('f-linha').value,
        inicio: document.getElementById('f-inicio').value,
        equipe: document.getElementById('f-equipe').value,
        itens: document.getElementById('f-itens').value,
        obs: document.getElementById('f-obs').value
    };

    if (editingIndex !== null) {
        procedimentos[editingIndex] = proc;
    } else {
        procedimentos.push(proc);
    }

    save();
    renderCards();
    updateStats();
    closeModal();
}

// ─── CURVA ABC ───
function renderABC() {
    const list = getFiltered();
    const statusMap = { andamento:'Em Andamento', preparacao:'Em Preparação', agendado:'Agendado', concluido:'Concluído', cancelado:'Cancelado', reagendado:'Reagendado' };
    const statusColors = { andamento:'#ef4444', preparacao:'#f59e0b', agendado:'#10b981', concluido:'#6b7280', cancelado:'#f87171', reagendado:'#a78bfa' };

    // Build vendor stats
    const vendorMap = {};
    list.forEach(p => {
        if (!p.vendedor) return;
        if (!vendorMap[p.vendedor]) vendorMap[p.vendedor] = { total: 0, statuses: {} };
        vendorMap[p.vendedor].total++;
        vendorMap[p.vendedor].statuses[p.status] = (vendorMap[p.vendedor].statuses[p.status] || 0) + 1;
    });

    // Sort by total desc
    const vendors = Object.entries(vendorMap)
        .sort((a, b) => b[1].total - a[1].total)
        .map(([name, data]) => ({ name, ...data }));

    const grandTotal = vendors.reduce((s, v) => s + v.total, 0);

    if (vendors.length === 0) {
        document.getElementById('abcContent').innerHTML = '<div class="empty-state">Nenhum procedimento no período selecionado</div>';
        return;
    }

    // Assign ABC zones: A = top 80%, B = next 15%, C = rest
    let cumulative = 0;
    vendors.forEach(v => {
        const pct = grandTotal > 0 ? v.total / grandTotal * 100 : 0;
        cumulative += pct;
        v.pct = pct;
        v.cumulative = cumulative;
        v.zone = cumulative <= 80 ? 'A' : cumulative <= 95 ? 'B' : 'C';
    });

    const zoneA = vendors.filter(v => v.zone === 'A');
    const zoneB = vendors.filter(v => v.zone === 'B');
    const zoneC = vendors.filter(v => v.zone === 'C');

    // Status distribution (all filtered)
    const statusTotals = {};
    list.forEach(p => { statusTotals[p.status] = (statusTotals[p.status] || 0) + 1; });
    const stackedBars = Object.entries(statusTotals)
        .sort((a, b) => b[1] - a[1])
        .map(([s, n]) => {
            const w = grandTotal > 0 ? (n / grandTotal * 100).toFixed(1) : 0;
            return `<div class="abc-stacked-seg" style="width:${w}%;background:${statusColors[s] || '#6b7280'};color:#fff;" title="${statusMap[s]}: ${n}">
                ${w > 8 ? statusMap[s].split(' ')[0] : ''}
            </div>`;
        }).join('');

    // Render vendor rows
    function renderRows(vList) {
        return vList.map((v, i) => {
            const rank = vendors.indexOf(v) + 1;
            const barWidth = vendors[0].total > 0 ? (v.total / vendors[0].total * 100).toFixed(1) : 0;
            const statusPills = Object.entries(v.statuses)
                .sort((a,b) => b[1]-a[1])
                .map(([s, n]) => `<span class="abc-mini-pill" style="background:${statusColors[s]}22;color:${statusColors[s]};border:1px solid ${statusColors[s]}44;">${statusMap[s].replace('Em ','')} ×${n}</span>`).join('');
            return `
            <div class="abc-row">
                <span class="abc-rank" style="color:${v.zone==='A'?'#10b981':v.zone==='B'?'#f59e0b':'#9ca3af'}">#${rank}</span>
                <span class="abc-badge badge-${v.zone}">${v.zone}</span>
                <div style="flex:2;min-width:0;">
                    <div class="abc-name">${v.name}</div>
                    <div class="abc-status-pills">${statusPills}</div>
                </div>
                <div class="abc-bar-wrap">
                    <div class="abc-bar-track">
                        <div class="abc-bar-fill fill-${v.zone}" style="width:${barWidth}%"></div>
                    </div>
                    <span class="abc-count">${v.total}</span>
                    <span class="abc-pct">${v.pct.toFixed(1)}%</span>
                    <span class="abc-acum">∑${v.cumulative.toFixed(1)}%</span>
                </div>
            </div>`;
        }).join('');
    }

    // Detailed breakdown table
    const detailRows = vendors.map(v => {
        const byStatus = Object.entries(v.statuses).map(([s,n]) =>
            `<span class="abc-mini-pill" style="background:${statusColors[s]}22;color:${statusColors[s]};border:1px solid ${statusColors[s]}44;">${statusMap[s]} ×${n}</span>`
        ).join(' ');
        return `<tr>
            <td><span class="abc-badge badge-${v.zone}">${v.zone}</span></td>
            <td style="font-weight:600;">${v.name}</td>
            <td style="font-family:var(--mono);font-weight:700;">${v.total}</td>
            <td style="font-family:var(--mono);">${v.pct.toFixed(1)}%</td>
            <td style="font-family:var(--mono);">${v.cumulative.toFixed(1)}%</td>
            <td>${byStatus}</td>
        </tr>`;
    }).join('');

    const periodLabel = currentPreset === 'todos' ? 'Todos os registros' :
        currentPreset === 'hoje' ? 'Hoje' :
        currentPreset === 'semana' ? 'Esta semana' :
        currentPreset === 'mes' ? 'Este mês' :
        `${periodoDe} → ${periodoAte}`;

    document.getElementById('abcContent').innerHTML = `
    <div style="margin-bottom:16px;font-family:var(--mono);font-size:0.68rem;color:var(--text-dim);">
        Período: <span style="color:var(--accent)">${periodLabel}</span> &nbsp;·&nbsp; Total: <span style="color:var(--text);font-weight:700;">${grandTotal}</span> procedimentos
    </div>

    <div class="abc-summary">
        <div class="abc-sum-box zona-A">
            <div class="abc-sum-label">Zona A — Alta Performance</div>
            <div class="abc-sum-val">${zoneA.length}</div>
            <div class="abc-sum-sub">vendedor${zoneA.length !== 1 ? 'es' : ''} · ${zoneA.reduce((s,v)=>s+v.total,0)} cirurgias</div>
        </div>
        <div class="abc-sum-box zona-B">
            <div class="abc-sum-label">Zona B — Performance Média</div>
            <div class="abc-sum-val">${zoneB.length}</div>
            <div class="abc-sum-sub">vendedor${zoneB.length !== 1 ? 'es' : ''} · ${zoneB.reduce((s,v)=>s+v.total,0)} cirurgias</div>
        </div>
        <div class="abc-sum-box zona-C">
            <div class="abc-sum-label">Zona C — Baixa Performance</div>
            <div class="abc-sum-val">${zoneC.length}</div>
            <div class="abc-sum-sub">vendedor${zoneC.length !== 1 ? 'es' : ''} · ${zoneC.reduce((s,v)=>s+v.total,0)} cirurgias</div>
        </div>
    </div>

    <div class="abc-grid">
        <div class="abc-card full">
            <div class="abc-section-title"><span>◈</span> Distribuição por Status — Todos os Procedimentos</div>
            <div class="abc-stacked">${stackedBars}</div>
            <div style="display:flex;flex-wrap:wrap;gap:10px;margin-top:8px;">
                ${Object.entries(statusTotals).sort((a,b)=>b[1]-a[1]).map(([s,n])=>`
                    <span style="font-family:var(--mono);font-size:0.66rem;color:${statusColors[s]};display:flex;align-items:center;gap:4px;">
                        <span style="width:8px;height:8px;border-radius:50%;background:${statusColors[s]};display:inline-block;"></span>
                        ${statusMap[s]} (${n})
                    </span>`).join('')}
            </div>
        </div>

        <div class="abc-card full">
            <div class="abc-section-title"><span>▲</span> Ranking Completo de Vendedores</div>
            ${renderRows(vendors)}
        </div>
    </div>

    <div class="abc-card" style="margin-bottom:20px;">
        <div class="abc-section-title"><span>⊟</span> Detalhamento por Vendedor</div>
        <div style="overflow-x:auto;">
            <table class="abc-detail-table">
                <thead>
                    <tr>
                        <th>Zona</th>
                        <th>Vendedor</th>
                        <th>Qtd</th>
                        <th>% Individual</th>
                        <th>% Acumulado</th>
                        <th>Breakdown por Status</th>
                    </tr>
                </thead>
                <tbody>${detailRows}</tbody>
            </table>
        </div>
    </div>`;
}

// ─── PERIOD FILTER ───
function applyPreset(preset) {
    currentPreset = preset;
    const now = new Date();

    document.querySelectorAll('.preset-btn').forEach(b => b.classList.toggle('active', b.dataset.preset === preset));
    document.getElementById('periodCustom').style.display = preset === 'custom' ? 'flex' : 'none';

    if (preset === 'hoje') {
        periodoDe = periodoAte = todayStr();
    } else if (preset === 'semana') {
        const day = now.getDay();
        const diffMon = (day === 0 ? -6 : 1 - day);
        const mon = new Date(now); mon.setDate(now.getDate() + diffMon);
        const sun = new Date(mon); sun.setDate(mon.getDate() + 6);
        periodoDe = mon.toISOString().split('T')[0];
        periodoAte = sun.toISOString().split('T')[0];
    } else if (preset === 'mes') {
        periodoDe = new Date(now.getFullYear(), now.getMonth(), 1).toISOString().split('T')[0];
        periodoAte = new Date(now.getFullYear(), now.getMonth() + 1, 0).toISOString().split('T')[0];
    } else if (preset === 'todos') {
        periodoDe = '';
        periodoAte = '';
    } else if (preset === 'custom') {
        periodoDe = document.getElementById('filterDe').value || todayStr();
        periodoAte = document.getElementById('filterAte').value || todayStr();
        document.getElementById('filterDe').value = periodoDe;
        document.getElementById('filterAte').value = periodoAte;
    }

    updatePeriodResult();
    renderCards();
    if (currentView === 'timeline') renderTimeline();
}

function applyCustomPeriod() {
    periodoDe = document.getElementById('filterDe').value || '';
    periodoAte = document.getElementById('filterAte').value || '';
    updatePeriodResult();
    renderCards();
}

function updatePeriodResult() {
    const statusMap = {
        andamento: { label: 'Andamento', color: '#ef4444' },
        preparacao: { label: 'Preparação', color: '#f59e0b' },
        agendado:   { label: 'Agendado',  color: '#10b981' },
        concluido:  { label: 'Concluído', color: '#6b7280' },
        cancelado:  { label: 'Cancelado', color: '#f87171' },
        reagendado: { label: 'Reagendado',color: '#a78bfa' }
    };

    const inPeriod = currentPreset === 'todos'
        ? procedimentos
        : procedimentos.filter(p =>
            (!periodoDe || p.data >= periodoDe) &&
            (!periodoAte || p.data <= periodoAte)
        );

    const counts = {};
    inPeriod.forEach(p => { counts[p.status] = (counts[p.status] || 0) + 1; });

    const total = inPeriod.length;
    const html = `<span class="period-stat"><span class="period-stat-dot" style="background:var(--accent)"></span><span class="period-stat-num">${total}</span> total</span>` +
        Object.entries(statusMap)
            .filter(([k]) => counts[k])
            .map(([k, v]) => `<span class="period-stat">
                <span class="period-stat-dot" style="background:${v.color}"></span>
                <span class="period-stat-num">${counts[k]}</span> ${v.label}
            </span>`).join('');

    document.getElementById('periodResult').innerHTML = html;
}

// ─── FILTER / SEARCH ───
document.querySelectorAll('.filter-btn').forEach(btn => {
    btn.addEventListener('click', () => {
        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        currentFilter = btn.dataset.filter;
        renderCards();
    });
});

document.getElementById('searchBox').addEventListener('input', e => {
    searchTerm = e.target.value;
    renderCards();
});

// ─── VIEW SWITCH ───
function switchView(v) {
    currentView = v;
    document.getElementById('cards-view').style.display = v === 'cards' ? 'grid' : 'none';
    document.getElementById('timeline-view').style.display = v === 'timeline' ? 'block' : 'none';
    document.getElementById('table-view').style.display = v === 'table' ? 'block' : 'none';
    document.getElementById('abc-view').style.display = v === 'abc' ? 'block' : 'none';
    document.getElementById('tab-cards').classList.toggle('active', v === 'cards');
    document.getElementById('tab-timeline').classList.toggle('active', v === 'timeline');
    document.getElementById('tab-table').classList.toggle('active', v === 'table');
    document.getElementById('tab-abc').classList.toggle('active', v === 'abc');
    if (v === 'timeline') renderTimeline();
    if (v === 'table') renderTable();
    if (v === 'abc') renderABC();
}

// ─── TABLE SORT STATE ───
let tableSortCol = 'data';
let tableSortDir = 1;

const TABLE_COLS = [
    { key: 'data',         label: 'Data' },
    { key: 'hospital',     label: 'Hospital' },
    { key: 'status',       label: 'Status' },
    { key: 'medico',       label: 'Médico' },
    { key: 'procedimento', label: 'Procedimento' },
    { key: 'convenio',     label: 'Convênio' },
    { key: 'vendedor',     label: 'Vendedor' },
    { key: 'linha',        label: 'Linha' },
    { key: 'inicio',       label: 'Horário' },
    { key: 'equipe',       label: 'Equipe' },
    { key: 'itens',        label: 'Itens Autorização' },
    { key: 'obs',          label: 'Observações' },
    { key: '_acoes',       label: 'Ações', nosort: true }
];

function sortTable(key) {
    if (tableSortCol === key) {
        tableSortDir *= -1;
    } else {
        tableSortCol = key;
        tableSortDir = 1;
    }
    renderTable();
}

function renderTable() {
    const list = getFiltered();
    const statusMap = { andamento:'Em Andamento', preparacao:'Em Preparação', agendado:'Agendado', concluido:'Concluído', cancelado:'Cancelado', reagendado:'Reagendado' };

    // Sort
    const sorted = [...list].sort((a, b) => {
        let va = (a[tableSortCol] || '').toString().toLowerCase();
        let vb = (b[tableSortCol] || '').toString().toLowerCase();
        if (va < vb) return -1 * tableSortDir;
        if (va > vb) return 1 * tableSortDir;
        return 0;
    });

    const table = document.getElementById('procTable');

    // Header
    table.querySelector('thead').innerHTML = `<tr>${TABLE_COLS.map(c => `
        <th class="${tableSortCol === c.key ? 'sorted' : ''}" onclick="${c.nosort ? '' : `sortTable('${c.key}')`}" style="${c.nosort ? 'cursor:default;' : ''}">
            ${c.label}
            ${!c.nosort ? `<span class="sort-icon">${tableSortCol === c.key ? (tableSortDir === 1 ? '▲' : '▼') : '⇅'}</span>` : ''}
        </th>`).join('')}</tr>`;

    if (sorted.length === 0) {
        table.querySelector('tbody').innerHTML = `<tr><td colspan="${TABLE_COLS.length}" style="text-align:center;padding:40px;color:var(--text-dim);font-family:var(--mono);font-size:0.8rem;">Nenhum procedimento encontrado</td></tr>`;
        return;
    }

    table.querySelector('tbody').innerHTML = sorted.map(proc => {
        const realIndex = procedimentos.indexOf(proc);
        const dataFmt = proc.data ? new Date(proc.data + 'T00:00:00').toLocaleDateString('pt-BR') : '—';
        const itensFormatted = proc.itens ? proc.itens.split('\n').filter(l => l.trim()).join(' · ') : '—';
        const concludeBtn = proc.status !== 'concluido' && proc.status !== 'cancelado'
            ? `<button class="table-btn t-conclude" onclick="conclude(${realIndex})">✓</button>` : '';

        return `<tr class="row-${proc.status}" onclick="editProc(${realIndex})" title="Clique para editar">
            <td>${dataFmt}</td>
            <td title="${proc.hospital || ''}">${proc.hospital || '—'}</td>
            <td><span class="table-status-pill pill-${proc.status}">${statusMap[proc.status] || proc.status}</span></td>
            <td title="${proc.medico || ''}">${proc.medico || '—'}</td>
            <td class="wrap-cell" title="${proc.procedimento || ''}">${proc.procedimento || '—'}</td>
            <td>${proc.convenio || '—'}</td>
            <td title="${proc.vendedor || ''}">${proc.vendedor || '—'}</td>
            <td>${proc.linha || '—'}</td>
            <td>${proc.inicio || '—'}</td>
            <td>${proc.equipe || '—'}</td>
            <td class="items-cell" title="${proc.itens || ''}">${itensFormatted}</td>
            <td class="wrap-cell" title="${proc.obs || ''}">${proc.obs || '—'}</td>
            <td onclick="event.stopPropagation()">
                <div class="table-actions">
                    <button class="table-btn t-edit" onclick="editProc(${realIndex})">✏</button>
                    ${concludeBtn}
                    <button class="table-btn t-del" onclick="deleteProc(${realIndex})">✕</button>
                </div>
            </td>
        </tr>`;
    }).join('');
}

// ─── FORM: Hospital/Convenio outros ───
document.getElementById('f-hospital').addEventListener('change', function() {
    document.getElementById('g-outro-hosp').style.display = this.value === '__outro' ? 'block' : 'none';
});

document.getElementById('f-convenio').addEventListener('change', function() {
    document.getElementById('g-outro-conv').style.display = this.value === '__outro' ? 'block' : 'none';
});

// Close modal clicking outside
document.getElementById('modalOverlay').addEventListener('click', function(e) {
    if (e.target === this) closeModal();
});

// ─── EXPORT ───
function openExportModal() {
    // Set default date range to current month
    const now = new Date();
    const firstDay = new Date(now.getFullYear(), now.getMonth(), 1).toISOString().split('T')[0];
    const lastDay = new Date(now.getFullYear(), now.getMonth() + 1, 0).toISOString().split('T')[0];
    document.getElementById('exp-de').value = firstDay;
    document.getElementById('exp-ate').value = lastDay;
    document.getElementById('exportModal').classList.add('open');
}

function closeExportModal() {
    document.getElementById('exportModal').classList.remove('open');
}

function toggleTodosVendedores(el) {
    document.querySelectorAll('.exp-vendedor').forEach(v => v.checked = el.checked);
}

function doExport() {
    const de = document.getElementById('exp-de').value;
    const ate = document.getElementById('exp-ate').value;
    const vendedores = Array.from(document.querySelectorAll('.exp-vendedor:checked')).map(v => v.value);
    const statuses = Array.from(document.querySelectorAll('.exp-status:checked')).map(s => s.value);

    const filtered = procedimentos.filter(p => {
        if (de && p.data < de) return false;
        if (ate && p.data > ate) return false;
        if (vendedores.length && !vendedores.includes(p.vendedor)) return false;
        if (statuses.length && !statuses.includes(p.status)) return false;
        return true;
    });

    if (filtered.length === 0) {
        alert('Nenhum procedimento encontrado com os filtros selecionados.');
        return;
    }

    const statusMap = { andamento:'Em Andamento', preparacao:'Em Preparação', agendado:'Agendado', concluido:'Concluído', cancelado:'Cancelado', reagendado:'Reagendado' };

    // Sheet 1: Resumo completo
    const resumo = filtered.map(p => ({
        'Data': p.data ? new Date(p.data + 'T00:00:00').toLocaleDateString('pt-BR') : '',
        'Hospital': p.hospital || '',
        'Status': statusMap[p.status] || p.status,
        'Médico': p.medico || '',
        'Procedimento': p.procedimento || '',
        'Convênio': p.convenio || '',
        'Vendedor': p.vendedor || '',
        'Linha de Produtos': p.linha || '',
        'Início': p.inicio || '',
        'Equipe': p.equipe || '',
        'Itens Autorização / Solicitação': p.itens ? p.itens.replace(/\n/g, ' | ') : '',
        'Observações': p.obs || ''
    }));

    // Sheet 2: Por vendedor (cobrança WhatsApp)
    const vendedorRows = [];
    const vendedoresUnicos = [...new Set(filtered.map(p => p.vendedor).filter(Boolean))];
    vendedoresUnicos.forEach(v => {
        const procs = filtered.filter(p => p.vendedor === v);
        vendedorRows.push({ 'VENDEDOR': v.toUpperCase(), 'Data': '', 'Hospital': '', 'Procedimento': '', 'Convênio': '', 'Status': '', 'Itens': '' });
        procs.forEach(p => {
            vendedorRows.push({
                'VENDEDOR': '',
                'Data': p.data ? new Date(p.data + 'T00:00:00').toLocaleDateString('pt-BR') : '',
                'Hospital': p.hospital || '',
                'Procedimento': p.procedimento || '',
                'Convênio': p.convenio || '',
                'Status': statusMap[p.status] || p.status,
                'Itens': p.itens ? p.itens.replace(/\n/g, ' | ') : ''
            });
        });
        vendedorRows.push({ 'VENDEDOR': `Subtotal: ${procs.length} procedimento(s)`, 'Data':'','Hospital':'','Procedimento':'','Convênio':'','Status':'','Itens':'' });
        vendedorRows.push({ 'VENDEDOR': '', 'Data':'','Hospital':'','Procedimento':'','Convênio':'','Status':'','Itens':'' });
    });

    const wb = XLSX.utils.book_new();

    // Sheet 1
    const ws1 = XLSX.utils.json_to_sheet(resumo);
    ws1['!cols'] = [
        {wch:12},{wch:35},{wch:16},{wch:30},{wch:35},{wch:18},{wch:28},{wch:20},{wch:8},{wch:20},{wch:50},{wch:40}
    ];
    XLSX.utils.book_append_sheet(wb, ws1, 'Todos os Procedimentos');

    // Sheet 2
    const ws2 = XLSX.utils.json_to_sheet(vendedorRows);
    ws2['!cols'] = [{wch:30},{wch:12},{wch:35},{wch:35},{wch:18},{wch:16},{wch:50}];
    XLSX.utils.book_append_sheet(wb, ws2, 'Por Vendedor (Cobrança)');

    // Filename with date range
    const periodo = de && ate ? `_${de}_a_${ate}` : '';
    const filename = `mapa_cirurgico${periodo}.xlsx`;
    XLSX.writeFile(wb, filename);
    closeExportModal();
}

// Close export modal clicking outside
document.getElementById('exportModal').addEventListener('click', function(e) {
    if (e.target === this) closeExportModal();
});

// ─── INIT ───
renderCards();
updateStats();
updatePeriodResult();
</script>
</body>
</html>
